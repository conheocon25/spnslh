<!DOCTYPE html>
<html lang="en">	
	<body>				
		<div id="Session" class="widget-box" tal:attributes="alt Session/getId" tal:condition="php:Session->getStatus()==0?true:false">
			<div class="widget-title">
				<span class="icon"><i class="glyphicon glyphicon-th-list"></i></span>
				<div class="buttons">
					<a title="Chỉnh sửa"  	class="btn SessionUpdate" data-toggle="modal" href="#DialogSession" tal:attributes="data-session-id Session/getId"><i class="glyphicons-edit" /></a>
					<a title="In phiếu" 	class="Ticket btn" tal:attributes="alt Session/getURLPrint"><i class="glyphicons-print"></i></a>
				</div>
			</div>
			<div class="widget-content nopadding size-12">
				<div class="invoice-content">
					<div>						
						<div class="invoice-to">
							<ul>
								<li><span tal:content="Session/getUser/getName"/></li>
								<li><span tal:content="Session/getStatusPrint"/></li>
							</ul>
						</div>
						<div class="invoice-from">
							<ul>
								<li><span tal:content="Session/getDateTimePrint"/></li>
								<li><span tal:content="Session/getCustomer/getName"/></li>
							</ul>
						</div>
					</div>
					<table class="table table-striped table-hover">
						<thead>
							<tr>										
								<th width="30">STT</th>
								<th width="30" />
								<th><div class="text-left">TÊN</div></th>
								<th width="30">SL</th>
								<th width="80"><div class="text-right">Đ.GIÁ</div></th>
								<th width="80"><div class="text-right">T.TIỀN</div></th>									
								<th width="30"><i class="glyphicons-bin"/></th>									
							</tr>
						</thead>
						<tbody>
							<tr tal:repeat="Detail Session/getDetails1">
								<td><div class="text-center" tal:content="repeat/Detail/number" /></td>
								<td><img width="30" tal:attributes="src Detail/getCourse/getPicture"/></td>
								<td><a class="update-item" href="#DialogEdit" data-toggle="modal" 
									tal:attributes="id 			Detail/getId;
													idcourse 	Detail/getIdCourse;
													name 		Detail/getCourse/getName;
													count 		Detail/getCount;
													price 		Detail/getPrice;														
									" 
									tal:content="Detail/getCourse/getName"/>
								</td>
								<td><div class="text-center" tal:content="Detail/getCountPrint"/></td>
								<td><div class="text-right" tal:content="Detail/getPricePrint"/></td>
								<td><div class="text-right" tal:content="Detail/getValuePrint"/></td>									
								<td class="center"><a class="remove-item" href="#DialogDel" data-toggle="modal" tal:attributes="data-id Detail/getId"><i class="glyphicons-remove_2"/></a></td>
							</tr>
						</tbody>
					</table>
					<table width="100%">
						<tr><td tal:content="Session/getNote" /></tr>
						<tr>
							<td style="text-align:right;">GIẢM GIÁ %:</td>
							<td tal:content="Session/getDiscountPercent" style="color:#5476A6;text-align:right;"/>
							<th width="36" />
						</tr>
						<tr>
							<td style="text-align:right;">GIẢM GIÁ $:</td>
							<td tal:content="Session/getDiscountValuePrint" style="color:#5476A6;text-align:right;"/>
							<th width="36" />
						</tr>
						<tr>
							<td style="text-align:right;">TỔNG CỘNG:</td>
							<td tal:content="Session/getValuePrint" style="color:#5476A6;text-align:right;"/>
							<th width="36" />
						</tr>
					</table>
				</div>
			</div>
		</div>
		
		<div id="Session" class="widget-box" tal:attributes="alt Session/getId" tal:condition="php:Session->getStatus()!=0?true:false">
			<div class="widget-title">
				<span class="icon"><i class="glyphicon glyphicon-th-list"></i></span>
				<div class="buttons">					
					<a title="In phiếu" 	class="Ticket btn" tal:attributes="alt Session/getURLPrint"><i class="glyphicons-print"></i></a>
				</div>
			</div>
			<div class="widget-content nopadding size-12">
				<div class="invoice-content">
					<div>						
						<div class="invoice-to">
							<ul>
								<li><span tal:content="Session/getUser/getName"/></li>
								<li><span tal:content="Session/getStatusPrint"/></li>
							</ul>
						</div>
						<div class="invoice-from">
							<ul>
								<li><span tal:content="Session/getDateTimePrint"/></li>
								<li><span tal:content="Session/getCustomer/getName"/></li>
							</ul>
						</div>
					</div>
					<table class="table table-striped table-hover">
						<thead>
							<tr>										
								<th width="30">STT</th>
								<th width="30" />
								<th><div class="text-left">TÊN</div></th>
								<th width="30">SL</th>
								<th width="80"><div class="text-right">Đ.GIÁ</div></th>
								<th width="80"><div class="text-right">T.TIỀN</div></th>																	
							</tr>
						</thead>
						<tbody>
							<tr tal:repeat="Detail Session/getDetails1">
								<td><div class="text-center" tal:content="repeat/Detail/number" /></td>
								<td><img width="30" tal:attributes="src Detail/getCourse/getPicture"/></td>
								<td><span tal:content="Detail/getCourse/getName"/></td>
								<td><div class="text-center" tal:content="Detail/getCountPrint"/></td>
								<td><div class="text-right" tal:content="Detail/getPricePrint"/></td>
								<td><div class="text-right" tal:content="Detail/getValuePrint"/></td>																	
							</tr>
						</tbody>
					</table>
					<table width="100%">
						<tr><td tal:content="Session/getNote" /></tr>
						<tr>
							<td style="text-align:right;">GIẢM GIÁ %:</td>
							<td tal:content="Session/getDiscountPercent" style="color:#5476A6;text-align:right;"/>							
						</tr>
						<tr>
							<td style="text-align:right;">GIẢM GIÁ $:</td>
							<td tal:content="Session/getDiscountValuePrint" style="color:#5476A6;text-align:right;"/>							
						</tr>
						<tr>
							<td style="text-align:right;">TỔNG CỘNG:</td>
							<td tal:content="Session/getValuePrint" style="color:#5476A6;text-align:right;"/>							
						</tr>
					</table>
				</div>
			</div>
		</div>
		
		<!-- DIALOG EDIT	-->
		<div id="DialogEdit" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h3><i class="glyphicons-fast_food modal-icon"/>CẬP NHẬT SẢN PHẨM</h3>
					</div>								
					<form id="FormSDUpdate" action="#" class="form-horizontal" novalidate="novalidate">
						<div class="form-group">
							<label class="control-label">Id</label>
							<div class="controls"><input readonly="true" id="IdCourse1" name="IdCourse1" type="text" class="form-control input-small"/></div>
						</div>
						<div class="form-group">
							<label class="control-label">Tên</label>
							<div class="controls"><input readonly="true" id="Name1" name="Name1" type="text" class="form-control input-small"/></div>
						</div>
						<div class="form-group">
							<label class="control-label">Số lượng</label>
							<div class="controls"><input id="Count1" name="Count1" type="text" class="form-control input-small"/></div>
						</div>
						<div class="form-group">
							<label class="control-label">Đơn giá</label>
							<div class="controls"><input id="Price1" name="Price1" type="text" class="form-control input-small"/></div>
						</div>									
						<div class="form-actions">										
							<button id="URLUpdButton" class="btn btn-primary btn-small" type="submit" value="Validate"><i class="glyphicons-download_alt"/> Lưu</button>
							<button data-dismiss="modal" class="btn btn-default btn-small"><i class="glyphicons-undo"/> Hủy</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- END DIALOG EDIT -->
																					
		<!-- DIALOG SESSION EDIT	-->
		<div id="DialogSession" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header"><h3><i class="glyphicons-edit modal-icon"/>CẬP NHẬT GIAO DỊCH</h3></div>
					<div class="form-horizontal">
						<div class="form-group">
							<label class="control-label">Bắt đầu</label>
							<div class="controls">
								<input id="DateTime1" name="DateTime1" type="text" class="form-control input-small" data-date-format="yyyy-mm-dd hh:ii"/>
							</div>
						</div>
						<div class="form-group">
							<label class="control-label">Kết thúc</label>
							<div class="controls">
								<input id="DateTimeEnd1" name="DateTimeEnd1" type="text" class="form-control input-small" data-date-format="yyyy-mm-dd hh:ii"/>
							</div>
						</div>
						<div class="form-group">
							<label class="control-label">Nhân viên</label>
							<div class="controls">
								<select name="IdEmployee1" id="IdEmployee1" style="width:80%;" class="form-control">
									<option tal:repeat="Employee EmployeeAll" tal:attributes="value Employee/getId;selected php:Session->getIdEmployee()==Employee->getId()?true:false">
										<span tal:content="Employee/getName" />
									</option>
								</select>
							</div>
						</div>
						<div class="form-group">
							<label class="control-label">Tính tiền</label>
							<div class="controls">
								<select name="Status1" id="Status1" style="width:80%;" class="form-control">
									<option tal:attributes="selected php:Session->getStatus()==0?'true':false" value="0">Đặt hàng</option>
									<option tal:attributes="selected php:Session->getStatus()==1?'true':false" value="1">Thanh toán đủ</option>
									<option tal:attributes="selected php:Session->getStatus()==2?'true':false" value="2">Nợ phiếu</option>
								</select>
							</div>
						</div>									
						<div class="form-group">
							<label class="control-label">Giảm giá %</label>
							<div class="controls">
								<input id="DiscountPercent1" name="DiscountPercent1" type="text" class="form-control input-small"/>
							</div>
						</div>
						<div class="form-group">
							<label class="control-label">Giảm giá tiền</label>
							<div class="controls">
								<input id="DiscountValue1" name="DiscountValue1" type="text" class="form-control input-small"/>
							</div>
						</div>
						<div class="form-group">
							<label class="control-label">Ghi chú</label>
							<div class="controls">
								<input id="Note1" name="Note1" type="text" class="form-control input-small"/>
							</div>
						</div>
						<div class="form-actions">
							<button id="URLSessionUpdButton" class="btn btn-primary btn-small"><i class="glyphicons-download_alt"/> Lưu</button>
							<button data-dismiss="modal" class="btn btn-default btn-small"><i class="glyphicons-undo"/> Hủy</button>
						</div>
						<div id="IdUser1"/>
						<div id="IdCustomer1"/>
						<div id="IdTable1"/>
						<div id="Surtax1"/>
						<div id="Payment1"/>
					</div>
				</div>
			</div>
		</div>
		<!-- END DIALOG EDIT -->
		<div metal:use-macro="mDialog.xhtml/DialogDel"/>
		
        <script type="text/javascript">
		/*<![CDATA[*/			
									
			//-----------------------------------------------------------------------------------
			//Delete 1 DETAIL			
			//-----------------------------------------------------------------------------------
			$('.remove-item').click(function(){$('#URLDelButton').attr('alt', $(this).attr('data-id'));});
			$('#URLDelButton').click(function(e){
				var URL = "/object/del/SessionDetail/" + $(this).attr('alt');
				$("#DialogDel").modal('hide');
				$.ajax({
					type: "POST",
					url: URL,
					success: function(msg){						
						var IdCustomer = $("#CustomerCurrent").attr('alt');						
						$("#SessionAll").load("/selling/load/customer/"+IdCustomer);
						$("#SessionView").load("/selling/session/load/" + $('#Session').attr('alt'));
					}
				});
			});
								
			//-----------------------------------------------------------------------------------
			//Update 1 SESSION
			//-----------------------------------------------------------------------------------
			$('.SessionUpdate').click(function(e){
				//Load dữ liệu JSON về
				var url = "/object/load/Session/" + $(this).attr('data-session-id');
				
				//Load dữ liệu JSON lên FORM
				$.getJSON(url, function(data){
					$('#URLSessionUpdButton').attr('alt', data.Id);
					$('#DateTime1').attr('value'		, data.DateTime);
					$('#DateTimeEnd1').attr('value'		, data.DateTimeEnd);
					$('#DiscountPercent1').attr('value'	, data.DiscountPercent);
					$('#DiscountValue1').attr('value'	, data.DiscountValue);
					$('#CustomerName').attr('value'		, data.CustomerName);					
					$('#Note1').attr('value'			, data.Note);
					
					$('#IdUser1').attr('alt'			, data.IdUser);
					$('#IdCustomer1').attr('alt'		, data.IdCustomer);
					$('#IdTable1').attr('alt'			, data.IdTable);
					$('#Surtax1').attr('alt'			, data.Surtax);
					$('#Payment1').attr('alt'			, data.Payment);
				});
			});
			
			$("#URLSessionUpdButton").click(function(){				
				var Data = [];
				Data[0] 	= $('#URLSessionUpdButton').attr('alt');
				Data[1] 	= $('#IdTable1').attr('alt');
				Data[2] 	= $('#IdUser1').attr('alt');				
				Data[3] 	= $('#IdCustomer1').attr('alt');				
				Data[4] 	= $('#IdEmployee1').val();
				Data[5] 	= $('#DateTime1').val();
				Data[6] 	= $('#DateTimeEnd1').val();
				Data[7] 	= $('#Note1').val();
				Data[8] 	= $('#Status1').val();
				Data[9] 	= $('#DiscountValue1').val();
				Data[10] 	= $('#DiscountPercent1').val();
				Data[11] 	= $('#Surtax1').val();
				Data[12] 	= "0";
				$("#DialogSession").modal('hide');
									
				var URL = "/object/upd/Session";
				$.ajax({
					type: "POST",
					data: {Data:Data},
					url: URL,
					success: function(msg){
						$("#SessionView").load("/selling/session/load/" + $('#Session').attr('alt'));
					}
				});
			});
									
			//-----------------------------------------------------------------------------------
			//Load 1 SESSION DETAIL
			//-----------------------------------------------------------------------------------
			$('.update-item').click(function(){
				$('#URLUpdButton').attr('alt', 	$(this).attr('Id')			);
				$('#IdCourse1').attr('value', 	$(this).attr('idcourse')	);
				$('#Name1').attr('value', 		$(this).attr('name')		);
				$('#Count1').attr('value', 		$(this).attr('count')		);
				$('#Price1').attr('value', 		$(this).attr('price')		);				
			});
												
			//-----------------------------------------------------------------------------------
			//Update 1 SESSION DETAIL
			//-----------------------------------------------------------------------------------
			$("#FormSDUpdate").validate({
				rules:{
					Count1:{
						min: 0,
						required:true
					},
					Price1:{
						min: 0,
						required:true
					}
				},
				errorClass: "help-inline",
				errorElement: "span",
				highlight:function(element, errorClass, validClass) {
					$(element).parents('.form-group').addClass('has-error');
				},
				unhighlight: function(element, errorClass, validClass){
					$(element).parents('.form-group').removeClass('has-error');
					$(element).parents('.form-group').addClass('has-success');
				},
				submitHandler: function (form) {										
					var Data = [];
					Data[0] = $('#URLUpdButton').attr('alt');
					Data[1] = $('#Session').attr('alt');
					Data[2] = $('#IdCourse1').val();
					Data[3] = $('#Count1').val();
					Data[4] = $('#Price1').val();
										
					$("#DialogEdit").modal('hide');
										
					var URL = "/object/upd/SessionDetail";
					$.ajax({
						type: "POST",
						data: {Data:Data},
						url: URL,
						success: function(msg){
							var IdCustomer = $("#CustomerCurrent").attr('alt');							
							$("#SessionAll").load("/selling/load/customer/"+IdCustomer);
							$("#SessionView").load("/selling/session/load/" + $('#Session').attr('alt'));
						}
					});
					return false;
				}
			});
			$("#DialogEdit").on('show.bs.modal', function(event){
				window.setTimeout(function(){
				$(event.currentTarget).find('input#Count1').first().focus()
				}, 0500);
			});
			
			$(".Ticket").click(function(){
				var url = $(this).attr('alt');
				var thePopup = window.open( url, "In Phiếu", "menubar=0,location=0,height=700,width=700" );
				thePopup.print();
			});
			
		/*]]>*/
		</script>
	</body>
</html>